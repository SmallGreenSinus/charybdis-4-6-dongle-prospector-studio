#include <dt-bindings/zmk/input_transform.h>
#include <input/processors.dtsi>

// Layer definitions
#define BASE 0
#define POINTER 1
#define LOWER 2
#define RAISE 3
#define SYMBOLS 4
#define SCROLL 5
#define FSCROLL 6
#define SNIPING 7
#define CARET 8

/ {
  split_inputs {
    #address-cells = <1>;
    #size-cells = <0>;

    trackball_split: trackball_split@0 {
      compatible = "zmk,input-split";
      reg = <0>;
    };
  };

  trackball_listener: trackball_listener {
    compatible = "zmk,input-listener";
    status = "disabled";
    device = <&trackball_split>;

    caret {
        layers = <CARET>;
        input-processors = <
            &zip_keybind_keys
            &zip_scroll_snap
        >;
        process-next;
    };

    // хак, чтобы на курсор не перемещался на слое CARE
    // https://github.com/zmkfirmware/zmk/issues/2967#issuecomment-2982313146
    caret-prevent-move {
        layers = <CARET>;
        input-processors = <&zip_xy_scaler 0 1>;
    };

    snipe {
      layers = <SNIPING>;
      input-processors = <&zip_xy_scaler 1 3>;
    };

    fast_scroll {
      layers = <FSCROLL>;
      input-processors = <&zip_xy_transform (INPUT_TRANSFORM_Y_INVERT)>, <&zip_xy_scaler 3 1>, <&zip_xy_to_scroll_mapper>;
    };

    scroll {
      layers = <SCROLL>;
      input-processors = <&zip_xy_transform (INPUT_TRANSFORM_Y_INVERT)>, <&zip_xy_scaler 1 3>, <&zip_xy_to_scroll_mapper>;
    };

    move {
      layers = <BASE POINTER>;
      input-processors = <&zip_xy_scaler 3 2>;
    };
  };

&zip_scroll_snap {
    x-threshold = <1 1>;
    y-threshold = <1 1>;
    xy-threshold = <1 1>;

    require-n-samples = <10>;
    immediate-snap-threshold = <1500>;
    lock-duration-ms = <200>;
    lock-for-next-n-events = <10>;
    idle-reset-timeout-ms = <200>;
};

/ {
    zip_keybind_keys: zip_keybind_keys {
        compatible = "zmk,input-processor-keybind";
        #input-processor-cells = <0>;
        track_remainders;
        bindings = <&kp RIGHT>,
                   <&kp LEFT>,
                   <&kp UP>,
                   <&kp DOWN>;
        tick = <40>;
        wait-ms = <0>;
        tap-ms = <10>;
    };

};
